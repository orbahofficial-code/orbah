<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>โปรไฟล์ผู้ใช้งาน</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- QR code (เบาและเสถียร) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <!-- Fallback QR decoder -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>document.documentElement.classList.add('app-loading');</script>


<style>
  /* reset เล็กน้อย */
  *{ box-sizing:border-box }
  html,body{ width:100%; height:100% }

  /* app-shell: หน้าไม่เลื่อน ให้ main เป็นพื้นที่เลื่อน */
  html, body{
    overflow:hidden;
    overscroll-behavior:none;
    -webkit-font-smoothing:antialiased;
    -webkit-text-size-adjust:100%;
    font-family:'Prompt',sans-serif;
    background:linear-gradient(135deg,#eef2ff 0%,#f8fafc 100%);
  }
  body{
    display:flex; flex-direction:column;
    min-height:100dvh; min-height:100svh;
    overflow-x:hidden;
  }

  header{ position:sticky; top:0; z-index:40;
    padding-top:env(safe-area-inset-top);
    backdrop-filter:saturate(180%) blur(8px);
    -webkit-backdrop-filter:saturate(180%) blur(8px);
  }

  /* main = พื้นที่เลื่อนหลัก */
  main{
    flex:1; min-height:0;               /* สำคัญมาก */
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    overscroll-behavior-y:contain;
    padding-bottom:max(16px, env(safe-area-inset-bottom));
  }

  :root{ --card-radius:1rem }
  .card{ border-radius:var(--card-radius); box-shadow:0 20px 50px -20px rgba(0,0,0,.15) }
  .avatar-ring{ box-shadow:0 0 0 4px #fff, 0 0 0 6px rgba(59,130,246,.6) }
  .pill{ border-radius:9999px }
  .sidebar-item.active{ background:#eef2ff; color:#1d4ed8; font-weight:600 }
  .grid-def{ grid-template-columns:1fr 1fr }
  @media (max-width:1024px){ .grid-def{ grid-template-columns:1fr } }
  .toast{ position:fixed; right:16px; top:16px; z-index:60; display:flex; flex-direction:column; gap:10px }
  .toast-item{ background:#111827; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:0 10px 20px -10px rgba(0,0,0,.3); min-width:260px; display:flex; gap:10px }

  /* skeleton ระหว่างโหลด */
  html.app-loading main{ opacity:0; pointer-events:none }
  #page-skeleton{ display:none }
  html.app-loading #page-skeleton{ display:block }

  /* modal */
  body.modal-open{ overflow:hidden } /* กันพื้นหลังเลื่อนเมื่อเปิดโมดัล */
  .modal{
    position:fixed; inset:0; display:none;
    align-items:center; justify-content:center;
    background:rgba(0,0,0,.55); z-index:50;
    overflow-y:auto; padding:16px;
  }
  .modal.show{ display:flex }
  .modal-card{
    background:#fff; border-radius:1rem; width:100%; max-width:560px;
    box-shadow:0 30px 60px -25px rgba(0,0,0,.35);
    max-height:min(90dvh,90vh); overflow:auto; -webkit-overflow-scrolling:touch; margin:auto;
  }

  /* ===== Manage table (เฉพาะแท็บจัดการ) ===== */
  /* ให้การ์ดของแท็บ manage เป็นคอลัมน์และยอมยุบความสูงได้ */
  [data-pane="manage"].card{
    display:flex;
    flex-direction:column;
    min-height:0;                 /* สำคัญ: ลูกจะไม่ดันสูงเกิน */
  }
  
  /* โครงห่อกรอบตาราง – กินพื้นที่ที่เหลือในการ์ด */
  .manage-table-wrap{
    flex:1 1 auto;
    min-height:0;                 /* สำคัญ */
    display:flex;
    flex-direction:column;
  }
  
  /* กรอบสโครลเฉพาะตาราง */
  #mgTableFrame{
    flex:1 1 auto;
    min-height:0;
    height:100%;
    max-height:none;              /* ใช้ความสูงจาก .manage-table-wrap */
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    border:1px solid #e5e7eb;     /* gray-200 */
    border-radius:.75rem;         /* rounded-lg */
    background:#fff;
  }
  
  /* บนจอเล็ก ถ้าตารางสูงไปให้กำหนดเพดาน */
  @media (max-width: 1024px){
    #mgTableFrame{ height:60vh; max-height:60vh; }
  }
  
  /* ตาราง + หัวตาราง sticky + ความกว้างคอลัมน์ */
  #mgTable{
    border-collapse:separate;
    table-layout:auto;
    min-width:1380px;             /* ให้มีสโครลแนวนอนได้ถ้าจอแคบ */
    width:100%;
  }
  #mgTable thead th{
    position:sticky;
    top:0;
    z-index:1;
    background:#fff;
  }
  
  /* ส่วนใหญ่ไม่ตัดคำ ยกเว้นคอลัมน์งานให้พับบรรทัดได้ */
  .table-nowrap th, .table-nowrap td{ white-space:nowrap; }
  td.col-task{ white-space:normal; word-break:break-word; }

</style>

</head>
<body class="min-h-screen">

  <!-- Top bar -->
  <header class="bg-white/90 shadow-sm sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 lg:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-indigo-600 text-white grid place-items-center">
          <i class="fa-solid fa-hospital-user"></i>
        </div>
        <div>
          <h1 class="text-base font-semibold text-gray-800">โปรไฟล์ผู้ใช้งาน</h1>
          <p class="text-xs text-gray-500">ระบบเข้า-ออก ห้องผ่าตัด</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600 hidden sm:inline">ยินดีต้อนรับ, <strong data-bind="fullname">ชื่อ-นามสกุล</strong></span>
        <button id="btnLogout" class="px-3 py-2 pill bg-indigo-600 text-white text-sm hover:bg-indigo-700">
          <i class="fa-solid fa-right-from-bracket mr-1"></i> ออกจากระบบ
        </button>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="max-w-7xl mx-auto px-4 lg:px-6 py-8">
    <div class="grid lg:grid-cols-[260px,1fr] gap-6">

      <!-- Sidebar -->
      <aside class="card bg-white p-4">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-14 h-14 rounded-full overflow-hidden avatar-ring">
            <img src="" alt="avatar" class="w-full h-full object-cover" data-bind="avatar">
          </div>
          <div>
            <div class="text-sm font-semibold text-gray-800" data-bind="fullname">ชื่อ-นามสกุล</div>
            <div class="text-xs text-gray-500" data-bind="roleLabel">บทบาท</div>
          </div>
        </div>
        <nav class="space-y-1 text-sm">
          <a href="#overview" class="sidebar-item active block px-3 py-2 rounded-lg" data-tab="overview"><i class="fa-solid fa-user mr-2"></i> Overview</a>
          <a href="#profile" class="sidebar-item block px-3 py-2 rounded-lg" data-tab="profile"><i class="fa-solid fa-id-card mr-2"></i> ข้อมูลส่วนตัว</a>
          <a href="#security" class="sidebar-item block px-3 py-2 rounded-lg" data-tab="security"><i class="fa-solid fa-shield-keyhole mr-2"></i> ความปลอดภัย</a>
          <a href="#work" class="sidebar-item block px-3 py-2 rounded-lg" data-tab="work"><i class="fa-solid fa-briefcase mr-2"></i> ปฏิบัติงาน</a>
          <a href="#manage" class="sidebar-item block px-3 py-2 rounded-lg" data-tab="manage"><i class="fa-solid fa-table-list mr-2"></i> จัดการ</a>
          <a href="#scan" class="sidebar-item block px-3 py-2 rounded-lg" data-tab="scan"> <i class="fa-solid fa-qrcode mr-2"></i> สแกน/ยืนยัน</a>
          <a href="#activity" class="sidebar-item block px-3 py-2 rounded-lg" data-tab="activity"><i class="fa-solid fa-clock-rotate-left mr-2"></i> กิจกรรมล่าสุด</a>
        </nav>
        <div class="mt-6 p-3 rounded-lg bg-indigo-50 text-indigo-700 text-xs">
          <i class="fa-solid fa-circle-info mr-1"></i>
          พบปัญหาติดต่อแอดมิน
        </div>
      </aside>

      <!-- Main Panel -->
      <section class="space-y-6">

        <!-- Profile Header Card -->
        <div class="card bg-white p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-4">
              <div class="w-24 h-24 rounded-full overflow-hidden avatar-ring">
                <img src="" alt="avatar" class="w-full h-full object-cover" data-bind="avatar">
              </div>
              <div>
                <div class="flex items-center gap-2">
                  <h2 class="text-xl font-semibold text-gray-800" data-bind="fullname">ชื่อ-นามสกุล</h2>
                  <span class="px-2 py-0.5 pill text-xs bg-emerald-100 text-emerald-700" data-bind="role">role</span>
                </div>
                <p class="text-sm text-gray-500"><span data-bind="position">ตำแหน่ง</span> • <span data-bind="workplaceOrCompany">หน่วยงาน</span></p>
                <p class="text-xs text-gray-400 mt-1">ชื่อผู้ใช้งาน: <span class="font-medium" data-bind="username">username</span></p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <label class="px-3 py-2 pill border border-gray-300 text-sm bg-white cursor-pointer hover:bg-gray-50">
                <i class="fa-solid fa-camera mr-1"></i> อัปโหลดรูปโปรไฟล์
                <input type="file" accept="image/*" class="hidden" id="avatarInput">
              </label>
              <button class="px-3 py-2 pill bg-white border border-gray-300 text-sm hover:bg-gray-50" id="btnShowQR">
                <i class="fa-solid fa-qrcode mr-1"></i> แสดง QR Code
              </button>
            </div>
          </div>
        </div>

        <!-- Overview -->
        <div class="card bg-white p-6" data-pane="overview">
          <h3 class="text-base font-semibold text-gray-800 mb-4">ข้อมูลโดยสรุป</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-50 rounded-xl p-4">
              <div class="text-xs text-gray-500">อีเมล</div>
              <div class="font-medium text-gray-800" data-bind="email">example@hospital.go.th</div>
            </div>
            <div class="bg-gray-50 rounded-xl p-4">
              <div class="text-xs text-gray-500">เบอร์โทร</div>
              <div class="font-medium text-gray-800" data-bind="phone">08x-xxx-xxxx</div>
            </div>
            <div class="bg-gray-50 rounded-xl p-4">
              <div class="text-xs text-gray-500">ตำแหน่ง</div>
              <div class="font-medium text-gray-800" data-bind="position">ตำแหน่ง</div>
            </div>
            <div class="bg-gray-50 rounded-xl p-4">
              <div class="text-xs text-gray-500">สถานที่ปฏิบัติงาน / หน่วยงาน</div>
              <div class="font-medium text-gray-800" data-bind="workplaceOrCompany">หน่วยงาน</div>
            </div>
          </div>
        </div>

        <!-- Table-like mapping -->
        <div class="card bg-white p-6" data-pane="overview">
          <h3 class="text-base font-semibold text-gray-800 mb-4">ข้อมูลจากตาราง</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-gray-500 border-b">
                  <th class="py-2 pr-4">คอลัมน์</th>
                  <th class="py-2">ค่า</th>
                </tr>
              </thead>
              <tbody class="text-gray-800">
                <tr class="border-b"><td class="py-2 pr-4 text-gray-500">username</td><td class="py-2" data-bind="username">username</td></tr>
                <tr class="border-b"><td class="py-2 pr-4 text-gray-500">role</td><td class="py-2" data-bind="role">role</td></tr>
                <tr class="border-b"><td class="py-2 pr-4 text-gray-500">first_name</td><td class="py-2" data-bind="first_name">ชื่อ</td></tr>
                <tr class="border-b"><td class="py-2 pr-4 text-gray-500">last_name</td><td class="py-2" data-bind="last_name">นามสกุล</td></tr>
                <tr class="border-b"><td class="py-2 pr-4 text-gray-500">position</td><td class="py-2" data-bind="position">ตำแหน่ง</td></tr>
                <tr class="border-b"><td class="py-2 pr-4 text-gray-500">workplace/company</td><td class="py-2" data-bind="workplaceOrCompany">หน่วยงาน</td></tr>
                <tr class="border-b"><td class="py-2 pr-4 text-gray-500">email</td><td class="py-2" data-bind="email">email</td></tr>
                <tr class="border-b"><td class="py-2 pr-4 text-gray-500">phone</td><td class="py-2" data-bind="phone">เบอร์โทร</td></tr>
                <tr><td class="py-2 pr-4 text-gray-500">status (เฉพาะ external)</td><td class="py-2" data-bind="status">approved/pending</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Editable Personal Info -->
        <div class="card bg-white p-6" data-pane="profile" style="display:none;">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-base font-semibold text-gray-800">แก้ไขข้อมูลส่วนตัว</h3>
            <span class="px-2 py-0.5 pill bg-gray-100 text-xs">draft</span>
          </div>

          <form id="editForm" class="grid grid-def gap-4">
            <div class="space-y-2">
              <label class="text-xs text-gray-500">ชื่อ</label>
              <input class="w-full border rounded-lg px-3 py-2" name="first_name" placeholder="ชื่อ">
            </div>
            <div class="space-y-2">
              <label class="text-xs text-gray-500">นามสกุล</label>
              <input class="w-full border rounded-lg px-3 py-2" name="last_name" placeholder="นามสกุล">
            </div>
            <div class="space-y-2">
              <label class="text-xs text-gray-500">ตำแหน่ง</label>
              <input class="w-full border rounded-lg px-3 py-2" name="position" placeholder="ตำแหน่ง">
            </div>
            <div class="space-y-2">
              <label class="text-xs text-gray-500">สถานที่ปฏิบัติงาน / หน่วยงาน</label>
              <input class="w-full border rounded-lg px-3 py-2" name="workplace" placeholder="หน่วยงาน">
            </div>
            <div class="space-y-2">
              <label class="text-xs text-gray-500">อีเมล</label>
              <input type="email" class="w-full border rounded-lg px-3 py-2" name="email" placeholder="email@domain">
            </div>
            <div class="space-y-2">
              <label class="text-xs text-gray-500">เบอร์โทร</label>
              <input class="w-full border rounded-lg px-3 py-2" name="phone" placeholder="08x-xxx-xxxx">
            </div>

            <div class="md:col-span-2 flex items-center justify-end gap-2 mt-2">
              <button type="button" id="btnReset" class="px-4 py-2 pill border border-gray-300 hover:bg-gray-50">ยกเลิก</button>
              <button id="btnSave" class="px-4 py-2 pill bg-indigo-600 text-white hover:bg-indigo-700">บันทึกการเปลี่ยนแปลง</button>
            </div>
          </form>
        </div>

        <!-- ความปลอดภัย -->
        <div class="card bg-white p-6" data-pane="security" style="display:none;">
          <h3 class="text-base font-semibold text-gray-800 mb-4">ความปลอดภัย</h3>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="p-4 border rounded-xl">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-medium text-gray-800">Check-in</div>
                  <div class="text-xs text-gray-500">กรอกข้อมูลเข้าปฏิบัติงาน</div>
                </div>
                <button class="px-3 py-1.5 pill border text-sm hover:bg-gray-50" id="btnChangePwd" disabled>กด</button>
              </div>
            </div>
            <div class="p-4 border rounded-xl">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-medium text-gray-800">เปิดใช้ 2FA</div>
                  <div class="text-xs text-gray-500">ยืนยันตัวตนสองชั้น (แผนถัดไป)</div>
                </div>
                <button class="px-3 py-1.5 pill border text-sm" disabled>เร็วๆ นี้</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Work (Check-in / Check-out) -->
        <div class="card bg-white p-6" data-pane="work" style="display:none;">
          <h3 class="text-base font-semibold text-gray-800 mb-4">ปฏิบัติงาน</h3>
          <div class="p-4 border rounded-xl">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-medium text-gray-800">Check-in</div>
                <div class="text-xs text-gray-500">กรอกข้อมูลเข้าปฏิบัติงาน แล้วแสดง QR ให้เจ้าหน้าที่สแกน</div>
              </div>
              <button id="btnWorkCheckin" class="px-3 py-1.5 pill border text-sm hover:bg-gray-50">
                กรอกข้อมูลเข้าทำงาน / เช็คเอาต์
              </button>
            </div>
          </div>
        </div>

        <!-- Manage (Admin dashboard) -->
        <div class="card bg-white p-6" data-pane="manage" style="display:none;">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-base font-semibold text-gray-800">การปฏิบัติงาน (บุคคลภายนอก)</h3>
            <div class="flex flex-wrap items-center gap-2 text-sm">
              <input type="date" id="mgFrom" class="border rounded-lg px-2 py-1">
              <input type="date" id="mgTo" class="border rounded-lg px-2 py-1">
              <select id="mgStatus" class="border rounded-lg px-2 py-1">
                <option value="all">สถานะทั้งหมด</option>
                <option value="pending">รอยืนยัน (pending)</option>
                <option value="checked">เช็คอิน (checked)</option>
                <option value="done">เช็คเอาต์แล้ว (done)</option>
              </select>
              <select id="mgRole" class="border rounded-lg px-2 py-1">
                <option value="external">บุคคลภายนอก</option>
                <option value="all">บุคลากร รพ.</option>
              </select>
              <input id="mgQuery" class="border rounded-lg px-3 py-1" placeholder="ค้นหา: ชื่อ/งาน/ห้อง/username">
              <button id="mgRefresh" class="px-3 py-1 pill border hover:bg-gray-50">รีเฟรช</button>
            </div>
          </div>
        
          <!-- Summary -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
            <div class="rounded-xl bg-gray-50 p-4">
              <div class="text-xs text-gray-500">ทั้งหมด</div>
              <div id="sumTotal" class="text-2xl font-semibold">0</div>
            </div>
            <div class="rounded-xl bg-amber-50 p-4">
              <div class="text-xs text-amber-700">รอยืนยัน</div>
              <div id="sumPending" class="text-2xl font-semibold text-amber-700">0</div>
            </div>
            <div class="rounded-xl bg-emerald-50 p-4">
              <div class="text-xs text-emerald-700">เช็คอิน (Active)</div>
              <div id="sumActive" class="text-2xl font-semibold text-emerald-700">0</div>
            </div>
            <div class="rounded-xl bg-indigo-50 p-4">
              <div class="text-xs text-indigo-700">เช็คเอาต์แล้ว</div>
              <div id="sumDone" class="text-2xl font-semibold text-indigo-700">0</div>
            </div>
          </div>
        
          <!-- Table area (scroll only inside this box) -->
          <div class="manage-table-wrap">
            <div id="mgTableFrame">
              <table id="mgTable" class="min-w-full text-sm table-nowrap">
                <thead>
                  <tr class="text-left text-gray-500 border-b">
                    <th class="py-2 pr-4">เริ่ม (created)</th>
                    <th class="py-2 pr-4">ชื่อ</th>
                    <th class="py-2 pr-4">หน่วยงาน</th>
                    <th class="py-2 pr-4">งาน</th>
                    <th class="py-2 pr-4">ห้อง</th>
                    <th class="py-2 pr-4">สถานะ</th>
                    <th class="py-2 pr-4">เช็คอินโดย/เวลา</th>
                    <th class="py-2 pr-4">เช็คเอาต์โดย/เวลา</th>
                    <th class="py-2">ระยะเวลา</th>
                  </tr>
                </thead>
                <tbody id="mgTbody" class="text-gray-800">
                  <tr><td class="py-3 text-gray-400" colspan="9">ไม่มีข้อมูล</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>



      <!-- Scan (OR staff only) -->
      <div class="card bg-white p-6" data-pane="scan" style="display:none;">
        <div class="flex items-center justify-between">
          <h3 class="text-base font-semibold text-gray-800">สแกน QR Code</h3>
          <button id="btnOpenCamera" class="px-3 py-2 pill bg-emerald-600 text-white hover:bg-emerald-700">
            <i class="fa-solid fa-camera mr-1"></i> สแกน QR Code
          </button>
        </div>
      
        <!-- พื้นที่สแกนด้วยกล้อง -->
        <div id="scannerWrap" class="hidden mt-4">
          <div class="relative rounded-xl border overflow-hidden bg-black">
            <video id="scanVideo" class="w-full h-64 object-cover" autoplay playsinline muted></video>
            <!-- overlay กรอบสแกน -->
            <div class="absolute inset-0 pointer-events-none ring-2 ring-white/80 rounded-lg m-8"></div>
            <!-- overlay สปินเนอร์ขณะอ่านข้อมูล -->
            <div id="scanBusy" class="absolute inset-0 bg-black/40 text-white hidden items-center justify-center">
              <div class="flex items-center gap-2 text-sm">
                <i class="fa-solid fa-spinner fa-spin"></i>
                <span class="msg">กำลังอ่านข้อมูล...</span>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2 pt-3">
            <button id="btnStopCamera" class="px-3 py-2 pill border hover:bg-gray-50">หยุดกล้อง</button>
            <span id="scanStatus" class="text-xs text-gray-500">กด “สแกน QR Code” เพื่อเริ่ม</span>
          </div>
          <!-- แคนวาสสำหรับ jsQR (ซ่อน) -->
          <canvas id="scanCanvas" width="640" height="480" class="hidden"></canvas>
        </div>
      </div>


        <!-- Activity placeholder -->
        <div class="card bg-white p-6" data-pane="activity" style="display:none;">
          <h3 class="text-base font-semibold text-gray-800 mb-4">กิจกรรมล่าสุด</h3>
          <p class="text-sm text-gray-500">จะเติมภายหลัง...</p>
        </div>

      </section>
    </div>
  </main>

  <!-- QR Code Modal -->
  <div class="modal" id="qrModal">
    <div class="modal-card p-6">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-lg font-semibold" id="qrTitle">QR Code ของฉัน</h4>
        <button class="text-gray-500 hover:text-gray-700" data-close="qrModal">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="grid place-items-center py-2">
        <canvas id="qrCanvas" width="220" height="220" class="rounded-2xl border p-3 bg-white"></canvas>
      </div>

      <div class="flex gap-2 justify-center pt-4">
        <a id="btnDownloadQR" download="my_qr.png" class="px-3 py-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 inline-flex items-center">
          <i class="fa-solid fa-download mr-2"></i> ดาวน์โหลด
        </a>
        <button id="btnPrintQR" class="px-3 py-2 rounded-full border hover:bg-gray-50">
          <i class="fa-solid fa-print mr-2"></i> พิมพ์
        </button>
      </div>
    </div>
  </div>

  <!-- Work Check-in Modal -->
  <div class="modal" id="workModal">
    <div class="modal-card p-6">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-lg font-semibold">เข้าปฏิบัติงาน</h4>
        <button class="text-gray-500 hover:text-gray-700" data-close="workModal">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <form id="workForm" class="grid gap-4">
        <div>
          <label class="text-sm text-gray-600">งาน/ภารกิจ</label>
          <input name="task" class="w-full border rounded-lg px-3 py-2" placeholder="เช่น ดูแลเครื่องมือ / เข้าช่วยผ่าตัด" required>
        </div>
        <div>
          <label class="text-sm text-gray-600">ห้องที่ไปปฏิบัติงาน</label>
          <input name="room" class="w-full border rounded-lg px-3 py-2" placeholder="เช่น OR-3 / ห้องผ่าตัด 2" required>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" class="px-3 py-2 pill border" data-close="workModal">ยกเลิก</button>
          <button id="btnWorkSubmit" class="px-3 py-2 pill bg-indigo-600 text-white hover:bg-indigo-700">บันทึก & แสดง QR</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Work Status Modal (แสดงก่อน Check-out) -->
  <div class="modal" id="workStatusModal">
    <div class="modal-card p-6">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-lg font-semibold">สถานะการปฏิบัติงาน</h4>
        <button class="text-gray-500 hover:text-gray-700" data-close="workStatusModal">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="space-y-3 text-sm">
        <div><span class="text-gray-500">ชื่อ-นามสกุล:</span> <span id="wsFullname" class="font-medium"></span></div>
        <div><span class="text-gray-500">บริษัท/หน่วยงาน:</span> <span id="wsCompany" class="font-medium"></span></div>
        <div><span class="text-gray-500">งาน/ภารกิจ:</span> <span id="wsTask" class="font-medium"></span></div>
        <div><span class="text-gray-500">สถานที่ปฏิบัติงาน:</span> <span id="wsRoom" class="font-medium"></span></div>
        <div id="wsNote" class="text-xs text-gray-500"></div>
      </div>
      <div class="flex gap-2 justify-end pt-4">
        <button id="btnShowCheckoutQR" class="px-4 py-2 pill bg-rose-600 text-white hover:bg-rose-700">
          <i class="fa-solid fa-right-from-bracket mr-1"></i> แสดง QR Check-out
        </button>
      </div>
    </div>
  </div>

  <!-- Scan Preview Modal (ฝั่ง OR เมื่อสแกน) -->
  <div class="modal" id="scanPreviewModal">
    <div class="modal-card p-6">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-lg font-semibold">ยืนยันการปฏิบัติงาน</h4>
        <button class="text-gray-500 hover:text-gray-700" data-close="scanPreviewModal">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div id="scanPreviewBody" class="space-y-3 text-sm">
        <div class="grid gap-2">
          <div><span class="text-gray-500">ชื่อ-นามสกุล:</span> <span id="pvFullname" class="font-medium"></span></div>
          <div><span class="text-gray-500">บริษัท/หน่วยงาน:</span> <span id="pvCompany" class="font-medium"></span></div>
          <div><span class="text-gray-500">งาน/ภารกิจ:</span> <span id="pvTask" class="font-medium"></span></div>
          <div><span class="text-gray-500">สถานที่ปฏิบัติงาน:</span> <span id="pvRoom" class="font-medium"></span></div>
          <div id="pvNote" class="text-xs text-gray-500"></div>
        </div>
      </div>

      <div class="flex gap-2 justify-end pt-4" id="scanPreviewActions"></div>
    </div>
  </div>

  <!-- Skeleton overlay: โชว์ตอน html.app-loading -->
  <div id="page-skeleton" class="fixed inset-0 z-50 bg-white">
    <div class="max-w-7xl mx-auto px-4 lg:px-6 py-6">
      <div class="animate-pulse space-y-6">
        <!-- แถบบน -->
        <div class="h-12 bg-gray-200 rounded-xl"></div>
        <!-- การ์ดหัวโปรไฟล์ -->
        <div class="bg-white rounded-2xl shadow p-6">
          <div class="flex items-center gap-4">
            <div class="w-24 h-24 rounded-full bg-gray-200"></div>
            <div class="flex-1 space-y-3">
              <div class="h-5 bg-gray-200 rounded w-48"></div>
              <div class="h-4 bg-gray-200 rounded w-64"></div>
              <div class="h-3 bg-gray-200 rounded w-40"></div>
            </div>
          </div>
        </div>
        <!-- การ์ดอื่น ๆ แบบคร่าว ๆ -->
        <div class="grid lg:grid-cols-[260px,1fr] gap-6">
          <div class="bg-white rounded-2xl shadow p-4 h-64">
            <div class="h-5 bg-gray-200 rounded w-24 mb-3"></div>
            <div class="space-y-3">
              <div class="h-9 bg-gray-200 rounded"></div>
              <div class="h-9 bg-gray-200 rounded"></div>
              <div class="h-9 bg-gray-200 rounded"></div>
            </div>
          </div>
          <div class="space-y-6">
            <div class="bg-white rounded-2xl shadow p-6 h-40"></div>
            <div class="bg-white rounded-2xl shadow p-6 h-64"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  
  <!-- Toast -->
  <div class="toast" id="toast"></div>

<script>
  // ===== CONFIG =====
  const API_BASE = "https://script.google.com/macros/s/AKfycbzK9QDRUSEq5U18Pwa40TWA-f4NrGx1CR2xqtnHBRgMQ3kSP1LfaJDMZPRc4evwuww-/exec";
  const ROLE_TABS = {
    admin: ["overview","profile","work","security","activity","scan","manage"], 
    "hospital-staff": ["overview","profile","work","activity"],
    external: ["overview","profile","work"],
    "or-staff": ["overview","scan","activity"]
  };


  // ===== Helpers =====
  const $  = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const Toast = {
    show(msg, type="info", timeout=3000){
      const wrap = $("#toast");
      const item = document.createElement("div");
      item.className = "toast-item";
      item.innerHTML = `
        <div><i class="fa-solid ${type==="success"?"fa-circle-check":type==="error"?"fa-circle-xmark":"fa-circle-info"} mt-1"></i></div>
        <div class="text-sm leading-snug">${msg}</div>`;
      wrap.appendChild(item);
      setTimeout(()=>{ item.style.opacity="0"; item.style.transform="translateY(-6px)"; }, timeout-350);
      setTimeout(()=> item.remove(), timeout);
    }
  };

  // ปุ่มกำลังทำงาน: ใส่/เอา spinner + disable ปุ่ม
  function setBtnLoading(btn, on, textOn='กำลังตรวจสอบ...'){
    if(!btn) return;
    if(on){
      btn.disabled = true;
      btn.setAttribute('aria-busy','true');
      if(!btn.dataset.origHtml) btn.dataset.origHtml = btn.innerHTML;
      btn.innerHTML =
        `<span class="inline-flex items-center gap-2">
           <i class="fa-solid fa-spinner fa-spin"></i> ${textOn}
         </span>`;
      btn.classList.add('cursor-wait','opacity-70');
    }else{
      btn.disabled = false;
      btn.removeAttribute('aria-busy');
      if(btn.dataset.origHtml){
        btn.innerHTML = btn.dataset.origHtml;
        delete btn.dataset.origHtml;
      }
      btn.classList.remove('cursor-wait','opacity-70');
    }
  }

  // Scroll lock ที่ไม่แกว่งจอ (รองรับ iOS)
  let __lockY = 0;
  function lockBodyScroll(){
    __lockY = window.scrollY || document.documentElement.scrollTop || 0;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${__lockY}px`;
    document.body.style.left = '0';
    document.body.style.right = '0';
    document.body.classList.add('modal-open');
  }
  function unlockBodyScroll(){
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.right = '';
    document.body.classList.remove('modal-open');
    window.scrollTo(0, __lockY || 0);
  }

  function openModal(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.add('show');
    // ถ้าเป็น modal แรก -> ล็อกสโครล
    if (!document.querySelector('.modal.show:not(#'+id+')')) {
      lockBodyScroll();
    }
  }
  function closeModal(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.remove('show');
    // ถ้าไม่เหลือ modal เปิดอยู่ -> ปลดล็อก
    if (!document.querySelector('.modal.show')) {
      unlockBodyScroll();
    }
  }
  
  // ปุ่ม [data-close] รวม (ของเดิมใช้ต่อได้)
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-close]');
    if(!btn) return;
    const id = btn.getAttribute('data-close');
    if(id) closeModal(id);
  });

  
  function bindData(data){
    $$('[data-bind]').forEach(el=>{
      const key = el.getAttribute('data-bind');
      if(key==='avatar'){
        el.src = data.avatar_url || 'https://placehold.co/240x240/png?text=PROFILE';
      }else if(key==='workplaceOrCompany'){
        el.textContent = data.workplace || data.company || '-';
      }else{
        el.textContent = data[key] ?? '';
      }
    });

    const form = $('#editForm');
    if(form){
      form.first_name.value = data.first_name || '';
      form.last_name.value  = data.last_name  || '';
      form.position.value   = data.position   || '';
      form.workplace.value  = data.workplace || data.company || '';
      form.email.value      = data.email      || '';
      form.phone.value      = data.phone      || '';
    }
  }

  function fileToBase64(file){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = () => {
        const base64 = String(fr.result).split(',')[1] || '';
        resolve({ base64, mimeType: file.type || 'image/png', filename: file.name || 'avatar.png' });
      };
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }

  function ensureAuth(){
    const token = localStorage.getItem('auth_token');
    const username = localStorage.getItem('username');
    if(!token || !username){
      window.location.href = 'index.html';
      return null;
    }
    return { token, username };
  }

  async function apiPost(route, payload){
    const res = await fetch(`${API_BASE}?route=${encodeURIComponent(route)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload||{})
    });
    let data = {};
    try { data = await res.json(); } catch(_) {}
    if(!res.ok || data.ok === false){
      throw new Error(data?.message || `API error on route ${route}`);
    }
    return data;
  }

  function buildQrPayload(profile){
    return JSON.stringify({ q: profile.qr_id });
  }

  function drawQR(canvas, text){
    return new QRious({ element: canvas, size: 200, value: text, level: 'M' });
  }

  function dataUrlFromCanvas(canvas){
    try{ return canvas.toDataURL('image/png'); }catch(e){ return ''; }
  }

  // ===== App =====
  document.addEventListener('DOMContentLoaded', async () => {
    // กันถูกผูกซ้ำ (เช่นสคริปต์โหลดสองครั้ง)
    if (window.__PROFILE_BOOTED__) return;
    window.__PROFILE_BOOTED__ = true;
  
    // Tabs: click
    $$('.sidebar-item').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        const tab = a.getAttribute('data-tab');
        if (tab) setActiveTab(tab);
      });
    });
  
    // Tabs: hash
    window.addEventListener('hashchange', () => {
      const tab = (location.hash || '#overview').slice(1);
      setActiveTab(tab);
    });
  
    // Logout: ใช้ delegation ให้ทำงานเสมอ (เผื่อมี overlay/DOM เปลี่ยน)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('#btnLogout');
      if (!btn) return;
      e.preventDefault();
      try {
        ['auth_token','userRole','username','fullname','last_work_id']
          .forEach(k => { localStorage.removeItem(k); sessionStorage.removeItem(k); });
      } catch(_) {}
      // กันย้อนกลับด้วย Back
      location.replace('index.html');
    });
  
    // ต้องมี session
    const auth = (typeof ensureAuth === 'function') ? ensureAuth() : null;
    if (!auth) {
      // ปิดสเกเลตันถ้ามี แล้วออก
      document.documentElement.classList.remove('app-loading');
      return;
    }
  
    try {
      const res = await apiPost('get_profile', { username: auth.username });
      if (!res || res.ok === false || !res.data) {
        throw new Error(res?.message || 'โหลดโปรไฟล์ไม่สำเร็จ');
      }
  
      const profile = res.data;
      if (typeof bindData === 'function') bindData(profile);
      window.currentProfile = profile;
  
      if (profile.fullname) localStorage.setItem('fullname', profile.fullname);
      if (profile.role)     localStorage.setItem('userRole', profile.role);
  
      // ตั้งแท็บเริ่มต้น (เคารพ hash)
      const initialTab = (location.hash || '#overview').slice(1);
  
      if (typeof configureRoleUI === 'function') {
        // ฟังก์ชันนี้จะซ่อน/แสดงแท็บตาม role
        configureRoleUI(profile.role || localStorage.getItem('userRole') || 'external');
        // เผื่อบางเวอร์ชันไม่ได้เรียก setActiveTab ภายใน
        setActiveTab(initialTab);
      } else {
        setActiveTab(initialTab);
      }
    } catch (err) {
      console.error(err);
      if (window.Toast?.show) {
        Toast.show(err.message || 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้', 'error');
      } else {
        alert(err.message || 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้');
      }
      // redirect ออกหลังแจ้ง
      setTimeout(() => location.replace('index.html'), 1200);
    } finally {
      // เอา skeleton/placeholder ออกเสมอ ไม่ให้ค้าง
      document.documentElement.classList.remove('app-loading');
    }
  });



  // อัปโหลดรูปโปรไฟล์
  $('#avatarInput')?.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    if(!file.type.startsWith('image/')){ Toast.show('กรุณาเลือกไฟล์รูปภาพ','error'); return; }

    try{
      const payload = await fileToBase64(file);
      const res = await apiPost('upload_avatar', { username: localStorage.getItem('username'), file: payload });
      if(res?.ok && res.url){
        $$('img[data-bind="avatar"]').forEach(img=> img.src = res.url);
        Toast.show('อัปโหลดรูปโปรไฟล์สำเร็จ','success');
      }else{
        throw new Error(res?.message || 'อัปโหลดไม่สำเร็จ');
      }
    }catch(err){
      console.error(err);
      Toast.show(err.message || 'อัปโหลดไม่สำเร็จ','error');
    }finally{
      e.target.value = '';
    }
  });

  // แสดง QR ส่วนตัว (qr_id)
  $('#btnShowQR')?.addEventListener('click', () => {
    const qrId = (window.currentProfile && window.currentProfile.qr_id) || '';
    const payload = buildQrPayload({ qr_id: qrId });
    openModal('qrModal');
    const canvas = $('#qrCanvas');
    if (canvas) {
      drawQR(canvas, payload);
      const url = canvas.toDataURL('image/png');
      const dl  = $('#btnDownloadQR'); if (dl) dl.href = url || '#';
    }
  });

  // พิมพ์ QR
  $('#btnPrintQR')?.addEventListener('click', ()=>{
    const w = window.open('');
    const dataUrl = dataUrlFromCanvas($('#qrCanvas'));
    w.document.write(`<img src="${dataUrl}" style="width:300px;height:300px;">`);
    w.print();
    w.close();
  });

  // เซฟโปรไฟล์
  $('#btnSave')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const f = $('#editForm');
    if(!f) return;
    const body = {
      username: localStorage.getItem('username'),
      first_name: f.first_name.value.trim(),
      last_name:  f.last_name.value.trim(),
      position:   f.position.value.trim(),
      workplace:  f.workplace.value.trim(),
      email:      f.email.value.trim(),
      phone:      f.phone.value.trim()
    };
    try{
      const res = await apiPost('update_profile', body);
      if(res?.ok){
        Toast.show('บันทึกข้อมูลสำเร็จ','success');
        const data = res.data || body;
        data.fullname = (data.first_name||'') + ' ' + (data.last_name||'');
        bindData(data);
        window.currentProfile = { ...(window.currentProfile||{}), ...data };
      }
    }catch(err){
      console.error(err);
      Toast.show(err.message || 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้','error');
    }
  });

  // ยกเลิก -> รีโหลดข้อมูลจากเซิร์ฟเวอร์
  $('#btnReset')?.addEventListener('click', async ()=>{
    try{
      const prof = await apiPost('get_profile', { username: localStorage.getItem('username') });
      if(prof?.ok){
        bindData(prof.data || {});
        window.currentProfile = prof.data || {};
      }
    }catch(e){ /* ignore */ }
  });

  // ===== Check-in / Check-out (ตาม logic ที่ขอ) =====
  function buildWorkQrPayload(work_id, action = 'in'){
    return JSON.stringify({ w: work_id, a: action });
  }

  let __activeWork = null;

  async function fetchActiveWork(){
    const username = localStorage.getItem('username');
    if(!username) return null;
    try{
      const res = await apiPost('work_get_active', { username });
      if(res?.ok && res.work && res.work.work_id) return res; // { ok, work:{...}, profile:{...} }
    }catch(_){}
    return null;
  }

  function openWorkStatusModal(data){
    const profile = data.profile || {};
    const work = data.work || {};
    __activeWork = work;

    const fn = document.getElementById('wsFullname'); if (fn) fn.textContent = profile.fullname || localStorage.getItem('fullname') || '-';
    const cp = document.getElementById('wsCompany');  if (cp) cp.textContent = profile.company || profile.workplace || '-';
    const tk = document.getElementById('wsTask');     if (tk) tk.textContent = work.task || '-';
    const rm = document.getElementById('wsRoom');     if (rm) rm.textContent = work.room || '-';
    const nt = document.getElementById('wsNote');     if (nt) nt.textContent = work.started_at ? ('เริ่ม: ' + work.started_at) : '';

    openModal('workStatusModal');
  }

  // ปุ่มหลัก: ถ้าไม่มีงานค้าง -> เปิดฟอร์มเช็คอิน, ถ้ามี -> แสดงสถานะ + ปุ่ม QR out
  const btnWorkCheckin = $('#btnWorkCheckin');
  
  btnWorkCheckin?.addEventListener('click', async ()=>{
    setBtnLoading(btnWorkCheckin, true);   // ⬅️ เริ่มหมุน
    try{
      const r = await (typeof fetchActiveWork === 'function'
                        ? fetchActiveWork()
                        : Promise.resolve(null)).catch(()=>null);
  
      if (r?.work?.work_id && r.work.is_checked_in && !r.work.is_checked_out) {
        // มีงานค้างที่เช็คอินอยู่ -> เปิดสถานะงาน
        openWorkStatusModal(r);
      } else {
        // ไม่มีงานค้าง -> เปิดฟอร์มกรอกงาน
        openModal('workModal');
      }
    } finally {
      // หน่วงนิดให้ผู้ใช้เห็นว่ามีการทำงานจริง
      setTimeout(()=> setBtnLoading(btnWorkCheckin, false), 200); // ⬅️ หยุดหมุน
    }
  });


  // บันทึกข้อมูลงาน + แสดง QR (Check-in)
const btnWorkSubmit = $('#btnWorkSubmit');

btnWorkSubmit?.addEventListener('click', async (e)=>{
  e.preventDefault();

  const f = $('#workForm');
  if(!f) return;

  const task = f.task.value.trim();
  const room = f.room.value.trim();
  if(!task || !room){
    Toast.show('กรุณากรอกข้อมูลให้ครบ','error');
    return;
  }

  // เริ่มโหลดดิ้ง + กันกดซ้ำ + ล็อกฟอร์ม
  setBtnLoading(btnWorkSubmit, true, 'กำลังสร้าง QR...');
  const controls = Array.from(f.elements);
  controls.forEach(el => el.disabled = true);

  try{
    const username = localStorage.getItem('username') || '';
    const res = await apiPost('work_init', { username, task, room });
    if(!res?.ok || !res.work_id) throw new Error(res?.message || 'ไม่สามารถสร้างรายการปฏิบัติงานได้');

    // จด work ล่าสุด (ถ้าต้องใช้ต่อ)
    try { localStorage.setItem('last_work_id', res.work_id); } catch(_){}

    // เตรียม QR (ทำก่อนแล้วค่อยเปิด modal เพื่อลดเฟลช)
    const canvas = $('#qrCanvas');
    if (canvas) {
      drawQR(canvas, buildWorkQrPayload(res.work_id, 'in'));
      const url = canvas.toDataURL('image/png');
      const dl  = $('#btnDownloadQR'); if (dl) dl.href = url || '#';
    }
    const title = $('#qrTitle'); if(title) title.textContent = 'QR Check-in';

    // แสดงผล
    closeModal('workModal');
    openModal('qrModal');
    Toast.show('สร้าง QR Check-in แล้ว','success');

  }catch(err){
    console.error(err);
    Toast.show(err.message || 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้','error');
  }finally{
    // ปลดล็อกฟอร์ม + ปิดโหลดดิ้ง
    controls.forEach(el => el.disabled = false);
    setBtnLoading(btnWorkSubmit, false);
  }
});


  // ปุ่มใน Work Status Modal: แสดง QR Check-out (ใช้ work_id เดิม)
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id === 'btnShowCheckoutQR'){
      if(!__activeWork || !__activeWork.work_id){ Toast.show('ไม่พบงานที่ค้างอยู่','error'); return; }
      closeModal('workStatusModal');
      const title = $('#qrTitle'); if(title) title.textContent = 'QR Check-out';
      openModal('qrModal');
      drawQR($('#qrCanvas'), buildWorkQrPayload(__activeWork.work_id, 'out'));
      const url = $('#qrCanvas').toDataURL('image/png');
      const dl  = $('#btnDownloadQR'); if (dl) dl.href = url || '#';
      Toast.show('แสดง QR Check-out (work เดิม)','success');
    }
  });

  // ===== ฟังก์ชันตั้งค่า UI ตามบทบาท =====
  function configureRoleUI(role){
    const allowed = ROLE_TABS[role] || ['overview'];
    $$('.sidebar-item').forEach(a=>{
      const tab = a.getAttribute('data-tab');
      a.style.display = allowed.includes(tab) ? '' : 'none';
    });
    $$('[data-pane]').forEach(p=>{
      const tab = p.getAttribute('data-pane');
      p.style.display = allowed.includes(tab) ? '' : 'none';
    });
    if (role === 'or-staff') {
      const workPane = document.querySelector('[data-pane="work"]');
      if (workPane) workPane.style.display = 'none';
    }
    const firstTab = (location.hash || `#${allowed[0] || 'overview'}`).slice(1);
    setActiveTab(firstTab);
  }

  // ====== SCANNER (Camera) ======
let scanStream = null;
let scanLoopId = null;
const hasBarcodeDetector = ('BarcodeDetector' in window);
let detector = null;
if (hasBarcodeDetector && window.BarcodeDetector?.getSupportedFormats) {
  try { detector = new BarcodeDetector({ formats: ['qr_code'] }); } catch(e) {}
}

// helper: toggle busy overlay บนวิดีโอ
function setScanBusy(on, text){
  const layer = document.getElementById('scanBusy');
  if(!layer) return;
  if (text) {
    const msg = layer.querySelector('.msg');
    if (msg) msg.textContent = text;
  }
  layer.classList.toggle('hidden', !on);
  // ให้ flex ทำงานเมื่อโชว์
  if (on) layer.classList.add('flex'); else layer.classList.remove('flex');
}

async function startScanner(){
  const wrap = $('#scannerWrap'); wrap?.classList.remove('hidden');
  const video = $('#scanVideo'); const canvas = $('#scanCanvas'); const status = $('#scanStatus');
  setScanBusy(false);
  try{
    if (!navigator.mediaDevices?.getUserMedia) {
      throw new Error('เบราว์เซอร์ไม่รองรับ getUserMedia');
    }
    scanStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } }, audio: false
    });
    video.srcObject = scanStream;
    await video.play();
    status.textContent = 'กำลังสแกน...';

    if (detector) {
      const step = async () => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          try {
            const codes = await detector.detect(video);
            if (codes && codes.length) return onQrDetected(codes[0].rawValue);
          } catch(e){}
        }
        scanLoopId = requestAnimationFrame(step);
      };
      scanLoopId = requestAnimationFrame(step);
    } else {
      // fallback: jsQR
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      const step = () => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = window.jsQR && jsQR(imageData.data, imageData.width, imageData.height);
          if (code && code.data) return onQrDetected(code.data);
        }
        scanLoopId = requestAnimationFrame(step);
      };
      scanLoopId = requestAnimationFrame(step);
    }
  }catch(err){
    console.error(err);
    status.textContent = 'เปิดกล้องไม่สำเร็จ';
    Toast.show('เปิดกล้องไม่ได้ (ต้องใช้ผ่าน HTTPS และอนุญาตสิทธิ์กล้อง)', 'error');
  }
}

// hideWrap=true จะซ่อนกล้อง, false จะหยุดสตรีมแต่ค้างกรอบไว้ (ใช้ตอนแสดงสปินเนอร์)
function stopScanner(hideWrap = true){
  try {
    if (scanLoopId) { cancelAnimationFrame(scanLoopId); scanLoopId = null; }
  } catch (_) {}

  try {
    const video = document.getElementById('scanVideo');
    if (video) {
      try { typeof video.pause === 'function' && video.pause(); } catch (_) {}
      const vStream = video.srcObject;
      if (vStream && typeof vStream.getTracks === 'function') {
        vStream.getTracks().forEach(t => { try { t.stop(); } catch (_) {} });
      }
      video.srcObject = null;
    }
  } catch (_) {}

  try {
    if (scanStream && typeof scanStream.getTracks === 'function') {
      scanStream.getTracks().forEach(t => { try { t.stop(); } catch (_) {} });
    }
  } catch (_) {} finally {
    scanStream = null;
  }

  try {
    const statusEl = document.getElementById('scanStatus');
    if (statusEl) statusEl.textContent = hideWrap ? 'หยุดกล้องแล้ว' : 'อ่านโค้ดได้ กำลังตรวจสอบ...';
    const wrap = document.getElementById('scannerWrap');
    if (hideWrap && wrap && !wrap.classList.contains('hidden')) wrap.classList.add('hidden');
  } catch (_) {}
}

// ==== สแกนแล้วแสดงพรีวิวสำหรับ OR ====
let __scanContext = { raw: null, work_id: null, qr_id: null, mode: 'in' };

// วาดข้อมูล + ปุ่มในโมดัลสแกน
function fillScanPreviewUI(pv){
  $('#pvFullname').textContent = pv.fullname || '-';
  $('#pvCompany').textContent  = pv.company || pv.workplace || '-';
  $('#pvTask').textContent     = pv.task || '-';
  $('#pvRoom').textContent     = pv.room || '-';

  const note = $('#pvNote');
  if (pv.status_text) { note.textContent = pv.status_text; note.style.display = ''; }
  else { note.style.display = 'none'; }

  const act = $('#scanPreviewActions');
  act.innerHTML = '';

  if (__scanContext.mode === 'in') {
    const btnIn = document.createElement('button');
    btnIn.className = 'px-4 py-2 pill bg-emerald-600 text-white hover:bg-emerald-700';
    btnIn.innerHTML = '<i class="fa-solid fa-right-to-bracket mr-1"></i> Check in';
    // กดแล้วมีสปินเนอร์
    btnIn.addEventListener('click', () => confirmScanAction('in', btnIn));
    act.appendChild(btnIn);
  } else {
    const btnOut = document.createElement('button');
    btnOut.className = 'px-4 py-2 pill bg-rose-600 text-white hover:bg-rose-700';
    btnOut.innerHTML = '<i class="fa-solid fa-right-from-bracket mr-1"></i> Check out';
    btnOut.addEventListener('click', () => confirmScanAction('out', btnOut));
    act.appendChild(btnOut);
  }

  // ปิด busy + ซ่อนกรอบกล้องก่อนโชว์ modal
  setScanBusy(false);
  $('#scannerWrap')?.classList.add('hidden');
  openModal('scanPreviewModal');
}

// ทำงานเมื่อกดปุ่มในโมดัล (รวม in/out)
async function confirmScanAction(action, btn){
  const checker_username = localStorage.getItem('username') || '';
  const checker_name = localStorage.getItem('fullname') || checker_username;

  // ล็อกปุ่มทั้งแถบกันกดซ้ำ
  const wrap = $('#scanPreviewActions');
  const allBtns = wrap ? Array.from(wrap.querySelectorAll('button')) : [];
  allBtns.forEach(b => b.disabled = true);
  setBtnLoading(btn, true, action === 'in' ? 'กำลังเช็คอิน...' : 'กำลังเช็คเอาต์...');

  try{
    if (action === 'in'){
      if (__scanContext.work_id) {
        await apiPost('work_confirm', { work_id: __scanContext.work_id, checker_username, checker_name });
      } else if (__scanContext.qr_id) {
        const r = await apiPost('scan_confirm_in', { qr_id: __scanContext.qr_id, checker_username, checker_name });
        if (!r?.ok) throw new Error(r?.message || 'เช็คอินไม่สำเร็จ');
      } else {
        throw new Error('ไม่มีข้อมูลงาน/QR ที่จะเช็คอิน');
      }
      Toast.show('เช็คอินสำเร็จ','success');
    } else {
      if (__scanContext.work_id) {
        await apiPost('work_checkout', { work_id: __scanContext.work_id, checker_username, checker_name });
      } else if (__scanContext.qr_id) {
        const r = await apiPost('scan_confirm_out', { qr_id: __scanContext.qr_id, checker_username, checker_name });
        if (!r?.ok) throw new Error(r?.message || 'เช็คเอาต์ไม่สำเร็จ');
      } else {
        throw new Error('ไม่มีข้อมูลงาน/QR ที่จะเช็คเอาต์');
      }
      Toast.show('เช็คเอาต์สำเร็จ','success');
    }

    closeModal('scanPreviewModal');

  }catch(err){
    console.error(err);
    Toast.show(err.message || 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้','error');
  }finally{
    // คืนปุ่ม
    setBtnLoading(btn, false);
    allBtns.forEach(b => b.disabled = false);
  }
}


async function handleConfirmCheckIn(){
  try{
    const checker_username = localStorage.getItem('username') || '';
    const checker_name = localStorage.getItem('fullname') || checker_username;
    if (__scanContext.work_id) {
      await apiPost('work_confirm', { work_id: __scanContext.work_id, checker_username, checker_name });
      Toast.show('เช็คอินสำเร็จ','success');
      closeModal('scanPreviewModal');
      return;
    }
    if (__scanContext.qr_id) {
      const r = await apiPost('scan_confirm_in', { qr_id: __scanContext.qr_id, checker_username, checker_name });
      if (r?.ok) { Toast.show('เช็คอินสำเร็จ','success'); closeModal('scanPreviewModal'); }
      else throw new Error(r?.message || 'เช็คอินไม่สำเร็จ');
      return;
    }
    throw new Error('ไม่มีข้อมูลงาน/QR ที่จะเช็คอิน');
  }catch(err){
    console.error(err);
    Toast.show(err.message || 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้','error');
  }
}

async function handleConfirmCheckOut(){
  try{
    const checker_username = localStorage.getItem('username') || '';
    const checker_name = localStorage.getItem('fullname') || checker_username;
    if (__scanContext.work_id) {
      await apiPost('work_checkout', { work_id: __scanContext.work_id, checker_username, checker_name });
      Toast.show('เช็คเอาต์สำเร็จ','success');
      closeModal('scanPreviewModal');
      return;
    }
    if (__scanContext.qr_id) {
      const r = await apiPost('scan_confirm_out', { qr_id: __scanContext.qr_id, checker_username, checker_name });
      if (r?.ok) { Toast.show('เช็คเอาต์สำเร็จ','success'); closeModal('scanPreviewModal'); }
      else throw new Error(r?.message || 'เช็คเอาต์ไม่สำเร็จ');
      return;
    }
    throw new Error('ไม่มีข้อมูลงาน/QR ที่จะเช็คเอาต์');
  }catch(err){
    console.error(err);
    Toast.show(err.message || 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้','error');
  }
}

async function onQrDetected(text){
  // หยุดสตรีม แต่ "ไม่ซ่อน" กรอบกล้อง -> จะได้เห็นสปินเนอร์ทับไว้
  stopScanner(false);
  setScanBusy(true, 'กำลังอ่านข้อมูล...');

  Toast.show('อ่าน QR สำเร็จ', 'success');

  let obj = null;
  try { obj = JSON.parse(text); } catch(e) { obj = null; }
  if (!obj || (!obj.w && !obj.q)) {
    setScanBusy(false);
    Toast.show('QR นี้ไม่ใช่รูปแบบที่ระบบรองรับ','error');
    return;
  }

  __scanContext = { raw: text, work_id: obj.w || null, qr_id: obj.q || null, mode: 'in' };

  try {
    // เส้นทางพรีวิวหลัก
    const pv = await apiPost('scan_preview', { work_id: obj.w, qr_id: obj.q });
    if (pv?.ok) {
      __scanContext.mode = pv.mode === 'out' ? 'out' : 'in';
      fillScanPreviewUI({
        fullname: pv.profile?.fullname || '-',
        company: pv.profile?.company || pv.profile?.workplace || '-',
        task: pv.work?.task || '-',
        room: pv.work?.room || '-',
        status_text: pv.status_text || (pv.mode==='out' ? 'พบการเช็คอินก่อนหน้า' : '')
      });
      return;
    }
  } catch (_) {
    // ไป fallback ต่อ
  }

  // Fallback: ดึงข้อมูลแยก
  let fullname = '-', company = '-', task = '-', room = '-', wantOut = false;
  try{
    if (obj.w) {
      const r = await apiPost('work_preview', { work_id: obj.w });
      if (r?.ok) {
        fullname = r.profile?.fullname || '-';
        company  = r.profile?.company || r.profile?.workplace || '-';
        task     = r.work?.task || '-';
        room     = r.work?.room || '-';
        wantOut  = !!r.work?.is_checked_in;
      }
    } else if (obj.q) {
      const r = await apiPost('profile_by_qr', { qr_id: obj.q });
      if (r?.ok) {
        fullname = r.profile?.fullname || '-';
        company  = r.profile?.company || r.profile?.workplace || '-';
        task     = r.latest_work?.task || '-';
        room     = r.latest_work?.room || '-';
        wantOut  = !!r.latest_work?.is_checked_in;
      }
    }
  }catch(e){ /* ignore */ }

  __scanContext.mode = wantOut ? 'out' : 'in';
  fillScanPreviewUI({
    fullname, company, task, room,
    status_text: wantOut ? 'พบการเช็คอินก่อนหน้า' : ''
  });
}

// เปิด/หยุดกล้อง
$('#btnOpenCamera')?.addEventListener('click', startScanner);
$('#btnStopCamera')?.addEventListener('click', ()=> stopScanner(true));


  
  // OR staff: ยืนยันจากโค้ด
  $('#btnScanConfirm')?.addEventListener('click', async ()=>{
    const raw = $('#scanPayload')?.value.trim();
    if(!raw){ Toast.show('กรุณาวางโค้ดที่อ่านจาก QR','error'); return; }
    let obj = null;
    try{ obj = JSON.parse(raw); }catch(e){ Toast.show('รูปแบบไม่ถูกต้อง (ต้องเป็น JSON)','error'); return; }
    if(!obj.w){ Toast.show('ไม่พบ work_id ในโค้ด','error'); return; }

    const action = (obj.a || 'in').toLowerCase();
    const route = action === 'out' ? 'work_checkout' : 'work_confirm';

    try{
      const checker_username = localStorage.getItem('username') || '';
      const checker_name = localStorage.getItem('fullname') || checker_username;
      await apiPost(route, { work_id: obj.w, checker_username, checker_name });
      Toast.show(action==='out' ? 'เช็คเอาต์สำเร็จ' : 'เช็คอินสำเร็จ', 'success');
      const ta = $('#scanPayload'); if(ta) ta.value = '';
    }catch(err){
      console.error(err);
      Toast.show(err.message || 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้','error');
    }
  });

  // ปุ่มล้างฟิลด์
  $('#btnScanClear')?.addEventListener('click', ()=> { const t=$('#scanPayload'); if(t) t.value=''; });

  // ===== Tabs =====
  function setActiveTab(tab){
    const panes = Array.from(document.querySelectorAll('[data-pane]'));
    const items = Array.from(document.querySelectorAll('.sidebar-item'));
    if (panes.length === 0) return;

    tab = (tab || (location.hash || '#overview').slice(1)).trim();

    const current =
      document.querySelector('.sidebar-item.active')?.getAttribute('data-tab') ||
      panes.find(p => p.style.display !== 'none')?.getAttribute('data-pane') ||
      'overview';

    const allowedTabs = new Set(panes.map(p => p.getAttribute('data-pane')));
    if (!allowedTabs.has(tab)) tab = 'overview';

    if (typeof stopScanner === 'function' && current === 'scan' && tab !== 'scan') {
      try { stopScanner(); } catch (_) {}
    }

    items.forEach(a => {
      const isActive = a.getAttribute('data-tab') === tab;
      a.classList.toggle('active', isActive);
      a.setAttribute('aria-current', isActive ? 'page' : 'false');
    });

    panes.forEach(p => {
      p.style.display = (p.getAttribute('data-pane') === tab) ? '' : 'none';
    });

    const newHash = '#' + tab;
    if (location.hash !== newHash) {
      try { history.replaceState(null, '', newHash); }
      catch (_) { location.hash = newHash; }
    }

    const firstFocusable = document.querySelector(
      `[data-pane="${tab}"] a, [data-pane="${tab}"] button, [data-pane="${tab}"] input, [data-pane="${tab}"] select, [data-pane="${tab}"] textarea, [data-pane="${tab}"] [tabindex="0"]`
    );
    if (firstFocusable) {
      try { firstFocusable.focus({ preventScroll: true }); } catch (_) {}
    }

    if (current !== tab) {
      document.dispatchEvent(new CustomEvent('tabchange', { detail: { tab, prev: current } }));
    }
  }

  
// ---- Admin Manage Tab ----
let __manageBooted = false;

function ymd(d){
  const dt = d instanceof Date ? d : new Date(d);
  const mm = String(dt.getMonth()+1).padStart(2,'0');
  const dd = String(dt.getDate()).padStart(2,'0');
  return `${dt.getFullYear()}-${mm}-${dd}`;
}
function fmt(dt){
  if(!dt) return '-';
  const d = new Date(dt);
  if (isNaN(d)) return String(dt||'-');
  return d.toLocaleString();
}
function diffHuman(start,end){
  if(!start) return '-';
  const s = new Date(start).getTime();
  const e = end ? new Date(end).getTime() : Date.now();
  if(isNaN(s)||isNaN(e)) return '-';
  let mins = Math.max(0, Math.round((e-s)/60000));
  const h = Math.floor(mins/60); mins = mins%60;
  return (h?`${h} ชม `:'') + `${mins} นาที`;
}

/* ===== styles เสริมให้ตาราง ===== */
function ensureManageStyles(){
  if (document.getElementById('mgTableStyles')) return;
  const css = `
    #mgTableFrame{max-height:65dvh;overflow:auto;border:1px solid #e5e7eb;border-radius:.75rem;background:#fff;}
    #mgTable{border-collapse:separate;table-layout:auto;min-width:1380px;}
    #mgTable thead th{position:sticky;top:0;z-index:1;background:#fff;}
    .table-nowrap th,.table-nowrap td{white-space:nowrap;}
    td.col-task{white-space:normal;word-break:break-word;}
  `;
  const s = document.createElement('style');
  s.id = 'mgTableStyles';
  s.textContent = css;
  document.head.appendChild(s);
}

/* ====== กำหนดความกว้างคอลัมน์ ====== */
const MG_COL_WIDTHS = [
  170, // วันที่สร้าง
  200, // ชื่อ-นามสกุล
  220, // บริษัท/หน่วยงาน
  280, // งาน/ภารกิจ (อนุญาตพับบรรทัด)
  140, // ห้อง
  120, // สถานะ
  240, // ผู้เช็คอิน + เวลา
  240, // ผู้เช็คเอาต์ + เวลา
  130  // ระยะเวลา
];

function ensureManageTableFrame(){
  const frame = document.getElementById('mgTableFrame');
  const table = document.getElementById('mgTable');
  if (!frame || !table) return null;

  // รับประกันว่าตารางกว้างพอสำหรับสโครลแนวนอน
  table.style.minWidth = '1380px';
  table.style.width = '100%';
  table.style.tableLayout = 'auto';
  return { frame, table };
}

/* ====== API ====== */
async function fetchAdminSummary(params){
  const res = await apiPost('work_admin_summary', params);
  if(!res?.ok) throw new Error(res?.message || 'โหลดสรุปล้มเหลว');
  return res.summary || { total:0, pending:0, active:0, done:0 };
}
async function fetchAdminList(params){
  const res = await apiPost('work_admin_list', params);
  if(!res?.ok) throw new Error(res?.message || 'โหลดรายการล้มเหลว');
  return res.rows || [];
}

/* ====== render ====== */
async function loadManage(){
  const from   = document.getElementById('mgFrom')?.value || ymd(new Date());
  const to     = document.getElementById('mgTo')?.value   || ymd(new Date());
  const status = document.getElementById('mgStatus')?.value || 'all';
  const role   = document.getElementById('mgRole')?.value   || 'external';
  const q      = document.getElementById('mgQuery')?.value?.trim() || '';

  ensureManageTableFrame();

  const [summary, rows] = await Promise.all([
    fetchAdminSummary({ from, to, status, role, q }),
    fetchAdminList({ from, to, status, role, q })
  ]);

  document.getElementById('sumTotal').textContent   = summary.total ?? rows.length;
  document.getElementById('sumPending').textContent = summary.pending ?? 0;
  document.getElementById('sumActive').textContent  = summary.active ?? 0;
  document.getElementById('sumDone').textContent    = summary.done ?? 0;

  const tb = document.getElementById('mgTbody');
  tb.innerHTML = '';
  if (!rows.length){
    tb.innerHTML = `<tr><td class="py-3 px-3 text-gray-400" colspan="9">ไม่พบข้อมูลตามเงื่อนไข</td></tr>`;
    return;
  }

  const frag = document.createDocumentFragment();
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.className = 'border-b align-top';
    const isActive = (r.status==='checked' && !r.checkout_time);

    const tdNowrap = (html, title) =>
      `<td class="py-2 px-3 whitespace-nowrap" title="${(title ?? html).toString().replace(/"/g,'&quot;')}">${html}</td>`;

    tr.innerHTML = `
      ${tdNowrap(fmt(r.created_at), r.created_at)}
      ${tdNowrap(r.fullname||'-')}
      ${tdNowrap(r.company||r.workplace||'-')}
      <td class="py-2 px-3 col-task">${r.task ? String(r.task) : '-'}</td>
      ${tdNowrap(r.room||'-')}
      ${tdNowrap(`
        <span class="px-2 py-0.5 pill text-xs ${r.status==='done'
          ?'bg-indigo-100 text-indigo-700'
          : isActive
            ?'bg-emerald-100 text-emerald-700'
            : r.status==='pending'
              ?'bg-amber-100 text-amber-700'
              :'bg-gray-100 text-gray-700'}">${r.status||'-'}</span>
      `, r.status||'-')}
      ${tdNowrap(`
        <div>${r.checkin_by_name||'-'}</div>
        <div class="text-xs text-gray-500">${fmt(r.checkin_time)}</div>
      `, (r.checkin_by_name||'-') + ' ' + (fmt(r.checkin_time)||''))}
      ${tdNowrap(`
        <div>${r.checkout_by_name||'-'}</div>
        <div class="text-xs text-gray-500">${fmt(r.checkout_time)}</div>
      `, (r.checkout_by_name||'-') + ' ' + (fmt(r.checkout_time)||''))}
      ${tdNowrap(diffHuman(r.checkin_time, r.checkout_time))}
    `;
    frag.appendChild(tr);
  });
  tb.appendChild(frag);
}

/* ====== boot ====== */
function bootManageTabOnce(){
  if (__manageBooted) return;
  __manageBooted = true;

  const today = ymd(new Date());
  const mgFrom = document.getElementById('mgFrom');
  const mgTo   = document.getElementById('mgTo');
  if (mgFrom) mgFrom.value = today;
  if (mgTo)   mgTo.value   = today;

  ensureManageTableFrame();

  ['mgFrom','mgTo','mgStatus','mgRole'].forEach(id=>{
    document.getElementById(id)?.addEventListener('change', ()=> {
      loadManage().catch(err=>Toast.show(err.message,'error'));
    });
  });

  let qTimer = null;
  document.getElementById('mgQuery')?.addEventListener('input', ()=>{
    clearTimeout(qTimer);
    qTimer = setTimeout(()=> loadManage().catch(err=>Toast.show(err.message,'error')), 300);
  });

  document.getElementById('mgRefresh')?.addEventListener('click', ()=>{
    loadManage().catch(err=>Toast.show(err.message,'error'));
  });

  loadManage().catch(err=>Toast.show(err.message,'error'));
}

// โหลดเมื่อสลับมาที่แท็บ manage
document.addEventListener('tabchange', (e)=>{
  if (e?.detail?.tab === 'manage') bootManageTabOnce();
});


</script>
</body>
</html>
